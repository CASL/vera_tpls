----------------------
Installing VERA at WEC
----------------------

ToDo: Document install of GCC, OpenMPI, CMake.

ToDo: Document repository cloning (and SSH tunnel).

---------------------------
Setting up the environment:
---------------------------

export VERA_INSTALL_BASE_DIR=/tools/vera
. $HOME/VERA.base/VERA/cmake/ctest/drivers/wec/load_dev_env.sh

NOTE: This is added to the .bash_profile for the WEC casluser account.
Therefore, this is set by default for casluser.


-----------------------
Testing build of MPACT:
-----------------------

$ cd /home/casluser/VERA.base/BUILDS/GCC-4.6.1/MPI_DEBUG
$ ln -s ../../../VERA/cmake/ctest/drivers/wec/do-configure.MPI_DEBUG do-configure
$ ./do-configure -DVERA_EXTRA_REPOSITORIES=Trilinos,TeuchosWrappersExt,MPACT \
   -DVERA_ENABLE_MPACT_libs=ON

NOTE: 2013/05/29: MPACT is currently not building (see VRI Kanban #2970).


------------------------
Installing LAPACK 3.3.1:
------------------------

???


------------------------
Installing Boost 1.49.0:
------------------------

$ cd /home/casluser/casl_tpls.svn/scripts/wec
$ env  TPL_INSTALL_DIR=/tools/vera/gcc-4.6.1 \
   PACKAGE_DIR=/home/casluser/casl_tpls.svn \
   MAKE_FLAGS=-j8 \
   ./boost-1.49.0.sh

NOTE: This current installl script only installs headers and does not
build any libraries!


------------------------------
Installing Zlib 1.2.5-patched:
------------------------------

$ cd /home/casluser/casl_tpls.svn/scripts/wec
$ env TPL_INSTALL_DIR=/tools/vera/gcc-4.6.1 \
  PACKAGE_DIR=/home/casluser/casl_tpls.svn  MAKE_FLAGS=-j16 \
  HDF5_DIR=/tools/vera/gcc-4.6.1/vera_cs/hdf5 \
  ./zlib.sh


----------------------
Installing MOAB 4.5.0:
----------------------

$ cd /home/casluser/casl_tpls.svn/scripts/wec
$ env TPL_INSTALL_DIR=/tools/vera/gcc-4.6.1 \
    PACKAGE_DIR=/home/casluser/casl_tpls.svn \
    MAKE_FLAGS=-j16 \
    ./moab-4.5.0.sh


------------------------
Testing DataTransferKit:
------------------------

$ cd /home/casluser/VERA.base/BUILDS/GCC-4.6.1/MPI_DEBUG
$ ln -s ../../../VERA/cmake/ctest/drivers/wec/do-configure.MPI_DEBUG do-configure
$ ./do-configure -DVERA_EXTRA_REPOSITORIES=Trilinos,DataTransferKit \
   -DVERA_ENABLE_DataTransferKit=ON

NOTE: 2013/05/29: This all builds but some tests time out:


93% tests passed, 4 tests failed out of 58

Label Time Summary:
DataTransferKit    = 2773.72 sec

Total Test time (real) = 702.36 sec

The following tests FAILED:
         17 - DataTransferKit_Rendezvous_test_MPI_4 (Timeout)
         31 - DataTransferKit_SharedDomainMap_test2_MPI_4 (Timeout)
         38 - DataTransferKit_SharedDomainMap_test9_MPI_4 (Timeout)
         43 - DataTransferKit_IntegralAssemblyMap_test4_MPI_4 (Timeout)

However, when I ran the tests manually without the timeout, they pass so it is a system problem likely.

NOTE: Having the DataTransferKit tests running shows that MOAB was installed correctly.


----------------------
Installing HDF5 1.8.7:
----------------------

$ cd /home/casluser/casl_tpls.svn/scripts/wec
$ env  TPL_INSTALL_DIR=/tools/vera/gcc-4.6.1 \
     PACKAGE_DIR=/home/casluser/casl_tpls.svn \
     MAKE_FLAGS=-j16  METHOD=opt \
     ZLIB_DIR=/tools/vera/gcc-4.6.1/toolset/zlib \
    ./hdf5-1.8.7.sh


------------------------
Installing Hypre 2.8.0b:
------------------------

$ cd /home/casluser/casl_tpls.svn/scripts/wec
$ env  TPL_INSTALL_DIR=/tools/vera/gcc-4.6.1 \
   PACKAGE_DIR=/home/casluser/casl_tpls.svn \
   LAPACK_DIR=/tools/vera/gcc-4.6.1/toolset/lapack \
   MAKE_FLAGS=-j16 \
   ./hypre-2.8.0b.sh


-------------------------
Installing PETSC 3.3.-p4:
-------------------------

$ cd /home/casluser/casl_tpls.svn/scripts/wec
$ env  TPL_INSTALL_DIR=/tools/vera/gcc-4.6.1 \
     PACKAGE_DIR=/home/casluser/casl_tpls.svn \
     LAPACK_DIR=/tools/vera/gcc-4.6.1/toolset/lapack \
     HYPRE_DIR=/tools/vera/gcc-4.6.1/common/hypre-2.8.0b \
     MAKE_FLAGS=-j16 \
     ./petsc-3.3-p4.sh

NOTE: 2013/05/30: It would seem that PETSC will go off at configure
time and try to find a version of blas and lapack on the system if it
fails to find the version that you point to with --with-blas-lib,
--with-lapack-lib, --with-blas-lapack-dir, etc.  This is bad because
it might find a different BLAS and LAPACK that will conflicit with
another version thath might be pulled in with another TPL.  This would
cause strange link and runtime errors.  This is very bad behavior and
shows a lack of consideration of larger projects with many TPL
dependencies, not just PETSC.  This is something to be carefully
watched after in other installs of PETSC.


----------------------
Testing against MPACT:
----------------------

$ cd /home/casluser/VERA.base/BUILDS/GCC-4.6.1/MPI_DEBUG
$ ./do-configure -DVERA_EXTRA_REPOSITORIES=Trilinos,TeuchosWrappersExt,MPACT \
  -DVERA_ENABLE_MPACT_libs=ON
$ make -j16
$ ctest -j16

...

95% tests passed, 4 tests failed out of 78

Label Time Summary:
MPACT_libs    = 270.89 sec

Total Test time (real) = 159.89 sec

The following tests FAILED:
          9 - MPACT_libsUtils_testAllocs_MPI_1 (Failed)
         53 - MPACT_libsMOC_testMOCSweeper_P0_MPI_1 (Failed)
         55 - MPACT_libsMOC_testMOCSweeper_AngSrc_MPI_1 (Failed)
         63 - MPACT_libsNodal_testNodalSweeper_MPI_4 (Failed)

These failing tests are described in more detail in VRI Kanban #2970.

Note the passing PETSC test:

MPACT_libsUtils_testTPLPETSC_MPI_1
...
TESTING PETSC TPL PASSED!

This is *not* a parallel test and does *not* show MPACT using PETSC
for a solve.  We ned to see that.


--------------------
Installing SILO 4.8:
--------------------

$ cd /home/casluser/casl_tpls.svn/scripts/wec
$ env  TPL_INSTALL_DIR=/tools/vera/gcc-4.6.1 \
    PACKAGE_DIR=/home/casluser/casl_tpls.svn \
    MAKE_FLAGS=-j16   METHOD=opt \
    HDF5_DIR=/tools/vera/gcc-4.6.1/vera_cs/hdf5 \
    ZLIB_DIR=/tools/vera/gcc-4.6.1/toolset/zlib \
    ./silo-4.8.sh


----------------------
Installing SPRNG 0.5:
----------------------

$ cd /home/casluser/casl_tpls.svn/scripts/wec
$ env  TPL_INSTALL_DIR=/tools/vera/gcc-4.6.1 \
      PACKAGE_DIR=/home/casluser/casl_tpls.svn \
      ./sprng-0.5.sh

NOTE: It turns out that VERA is currently disabling SPRNG :-)


--------------------
Installing QT 4.8.2:
--------------------

First, you need to modify QT source!  In the file:

  /home/casluser/casl_tpls.svn/qt/4.8.2/mkspecs/linux-g++-64/qmake.conf

add the lines:

  QMAKE_INCDIR_X11=/usr/include/X11
  QMAKE_LIBDIR_X11=/usr/lib64

after the default settings.

Then do:

$ cd /home/casluser/casl_tpls.svn/scripts/wec
$ env  TPL_INSTALL_DIR=/tools/vera/gcc-4.6.1 \
    PACKAGE_DIR=/home/casluser/casl_tpls.svn \
    MAKE_FLAGS=-j8  METHOD=opt \
    ./qt-4.8.2.sh

NOTE: 2013/05/29: We currently can not get QT to pass the configure
step as it says it can't find X11.  We have sent email requests to the
SCALE developers (who have the required dependence on QT) for help.

NOTE: When trying to configure and build QT on compute nodes bl20**,
the contents of /usr/lib64/ is different and is missing the libX11.a
library.  Therefore, you have to configure and build QT on the compile
node (newton) to get it to work.


---------------------------
Testing InsilicoNeutronics:
---------------------------

$ cd /home/casluser/VERA.base/BUILDS/GCC-4.6.1/MPI_DEBUG

$ ./do-configure -DVERA_ENABLE_InsilicoNeutronics=ON

$ make -j8 && ctest -j8

...

96% tests passed, 2 tests failed out of 54

Label Time Summary:
Insilico    = 727.87 sec

Total Test time (real) = 378.73 sec

The following tests FAILED:
         33 - InsilicoNeutronics_tstTransport_Denovo_SN_MPI_4 (Timeout)
         36 - InsilicoNeutronics_tstTransport_Denovo_SPN_MPI_4 (Timeout)

NOTE: 2013/05/30: These tests likely are doing expensive disk
operations and therefore timeout on the nfs mounted drives.


----------------------------------
Testing coupled Insilico+COBRA_TF:
----------------------------------

$ cd /home/casluser/VERA.base/BUILDS/GCC-4.6.1/MPI_DEBUG

$ . /do-configure -DVERA_ENABLE_InsilicoNeutronics=ON \
    -DVERA_ENABLE_VRIPSSneutronics=ON \
    -DVERA_ENABLE_VRIPSScobra_denovo=ON

$ make -j8 && ctest -j8

...


93% tests passed, 4 tests failed out of 57

Label Time Summary:
Insilico    = 896.88 sec
VRIPSS      = 1082.65 sec

Total Test time (real) = 1297.40 sec

The following tests FAILED:
         52 - InsilicoNeutronics_tstDTK_Adapter_MPI_4 (Timeout)
         33 - InsilicoNeutronics_tstTransport_Denovo_SN_MPI_4 (Timeout)
         36 - InsilicoNeutronics_tstTransport_Denovo_SPN_MPI_4 (Timeout)
         55 - VRIPSScobra_denovo_small_singlerod_HFP_8g (Failed)

NOTE: 2013/05/30: I manually killed the test
VRIPSScobra_denovo_small_singlerod_HFP_8g since I had no idea how long
it would take to finish running.  It does not have a timeout (but
likely should be given some timeout).



-------------------------------------------
Testing all WEC Test Stand VERA Components:
-------------------------------------------

Version of VERA components:

{{{
casluser@newton:~/VERA.base/VERA> egdist log-oneline -1        

*** Base Git Repo: VERA
c933b22 "Increasing timeout from 3 to 10 minutes." <francef@westinghouse.com> [Fri May 31 11:31:02 2013 -0400] (6 seconds

*** Git Repo: Trilinos
7948b74 "Adding an offical TriBITS FindTPLPETSC.cmake (Trilinos #5922)" <bartlettra@ornl.gov> [Wed May 29 22:39:06 2013 -0400] (34 hours ago)             

*** Git Repo: Trilinos/packages/TriKota/Dakota
39fb463 "Sync from DAKOTA stable dated 20130522" <dakota-developers@development.sandia.gov> [Wed May 22 17:02:18 2013 -0600] (9 days ago)

*** Git Repo: VERAInExt
bb9241f "Add cell_broadcast_size to [INSILICO] block" <palmtagsp@ornl.gov> [Wed May 29 15:31:07 2013 -0400] (2 days ago)

*** Git Repo: DataTransferKit
13c8d9b "Revert "Adding addition logic to top-level CMakeLists.txt for Zoltan/MPI provided"" <uy7@ornl.gov> [Thu May 16 07:41:21 2013 -0400] (2 weeks ago)

*** Git Repo: COBRA-TF
8f61d27 "    Adding a CMakeLists to enable the preprocessor test." <sankaranr@ornl.gov> [Mon May 13 13:18:21 2013 -0400] (2 weeks ago)

*** Git Repo: Scale
96eb4f8 "changeset:   8675:dc8cb145fea4" <clarnokt@ornl.gov> [Thu May 23 21:04:16 2013 -0400] (7 days ago)

*** Git Repo: Exnihilo
dd6eba6 "Merge branch 'master' of casl-dev:/git-root/Exnihilo" <davidsongg@ornl.gov> [Thu May 30 10:07:00 2013 -0400] (22 hours ago)

*** Git Repo: MPACT
919a058 "Commenting out MPACT_libsDriver testDriver that does not build on WEC (VRI Kanban #2970)" <francef@westinghouse.com> [Fri May 31 08:03:11 2013 -0400] (56 minutes ago)

*** Git Repo: LIMEExt
bb7ab27 "CASL Story #3882 - Throttle console output to proc 0 in parallel runs" <rhoope@sandia.gov> [Tue Mar 12 12:09:41 2013 -0600] (3 months ago)

*** Git Repo: PSSDriversExt
9f02002 "Add transfer of upper plenum (channel exit) density" <kbelco@sandia.gov> [Wed May 29 13:20:00 2013 -0400] (2 days ago)
}}}

Create the configure file:

{{{
$ cd ~/VERA.base/BUILDS/GCC-4.6.1/MPI_DEBUG
$ ln -s ../../../VERA/cmake/ctest/drivers/wec/do-configure.MPI_DEBUG do-configure
}}}

Configure the full list of WEC Test Stand VERA components:

{{{
./do-configure \
  -DVERA_ENABLE_CTeuchos=ON \
  -DVERA_ENABLE_ForTeuchos=ON \
  -DVERA_ENABLE_VERAIn=ON \
  -DVERA_ENABLE_DataTransferKit=ON \
  -DVERA_ENABLE_MPACT_libs=ON \
  -DVERA_ENABLE_Insilico=ON \
  -DVERA_ENABLE_COBRA_TF=ON \
  -DVERA_ENABLE_VRIPSS=ON
}}}

This enables the packages:

{{{ Final set of enabled SE packages: TeuchosCore TeuchosParameterList
TeuchosComm TeuchosNumerics TeuchosRemainder Teuchos Sacado RTOp
KokkosClassic Kokkos Epetra Zoltan Shards Triutils Tpetra EpetraExt
ThyraCore ThyraEpetraAdapters Thyra Isorropia AztecOO Amesos Ifpack ML
Belos Anasazi Stratimikos Intrepid CTeuchos ForTeuchos VERAIn
DataTransferKit COBRA_TFCore COBRA_TFUtils COBRA_TF ScaleDBC ScaleDBCF
jDebug StandardFlex StandardTimer StandardLoki StandardJson Standard
ScaleUtilsIO ScaleUtilsMath ScaleUtils FakeResdag ScaleDataComm
ScaleEndianUtils ScaleFortranFileStream ScaleList ScaleQtFortran
ScaleEnv ScaleSerialize ScaleSerializeFortran ScaleSTL ScaleFileUtils
ScaleFileUtilsFortran ScaleInputLib ScaleResource StdCompLib
InMemoryStdCompLib ScaleDataCore ScaleDataOrigen ScaleDataFiles
ScaleData ScaleInputLexer ScaleInputSIREN ScaleInputParser
ScaleInputVulcan ScaleInput ScaleReporter ScaleTextFileWriter AmpxLib
ScaleCell BaseScaleInput AmpxLoader AmpxLoaderFortran ScaleFinalizer
ScaleModule ScaleLib BasicGeom GridGeom OrigenIO Origen DefBlock
AmpxInput ReactionResource Senlib MipLib Crawdad AmpxLibUtils DANCOFF
XSProc Terpolate MixMacros MalocsPM Bonami XsdrnPM Centrm PMC Fulcrum
NemesisTools NemesisRelease NemesisHarness NemesisComm NemesisGtest
Nemesis TranscoreUtils TranscoreFields TranscoreMesh_type
TranscoreDatabase TranscoreAngle TranscoreGeometry TranscoreMaterial
TranscoreNuclide TranscoreXSLib TranscoreSolvers Transcore
DenovoKBA_mesh DenovoRTK_MD DenovoSource DenovoKBA_equations
DenovoKBA_uncflux DenovoCMFD DenovoMeshing DenovoKBA DenovoKBA_solvers
DenovoSPN DenovoKBA_io DenovoManagers Denovo InsilicoPyTools
InsilicoMOC InsilicoNeutronics Insilico MPACT_libsUtils
MPACT_libsReactor MPACT_libsCoreSolvers MPACT_libsMOC MPACT_libsSn
MPACT_libsCDP MPACT_libsNodal MPACT_libsCMFD MPACT_libsXS
MPACT_libsPlanarSynthesis MPACT_libsTransient MPACT_libsDepletion
MPACT_libsUI MPACT_libsLattice MPACT_libsDriver MPACT_libs LIME
VRIPSScommon VRIPSSutils VRIPSScobra VRIPSScobra_denovo
VRIPSSneutronics VRIPSSmpact VRIPSS 160
}}}

NOTE: When we tried to build LIME tests, we got a build failure for a
LIME test:

{{{
/home/casluser/VERA.base/VERA/LIMEExt/LIME/example/dtk2_wave_damper/../../../../DataTransferKit/src/DTK_Rende\
zvousMesh.hpp:52:27: fatal error: MBInterface.hpp: No such file or directory
compilation terminated.
make[2]: *** [LIMEExt/LIME/example/dtk2_wave_damper/CMakeFiles/LIME_WaveDamperExample.dir/Xfer_Operators.cpp.\
o] Error 1}}}

Therefore, we had to disable LIME tests (by removing LIME from the
list of explicitly enabled packages).

We then built everything (passing) and run the tests:

{{{
$ ctest -j16

...


99% tests passed, 5 tests failed out of 435

Label Time Summary:
COBRA_TF           = 661.59 sec
CTeuchos           =   0.58 sec
DataTransferKit    = 5637.56 sec
ForTeuchos         =   0.76 sec
Insilico           = 1918.26 sec
MPACT_libs         = 464.26 sec
VERAIn             =  21.04 sec
VRIPSS             = 1775.77 sec

Total Test time (real) = 2127.83 sec

The following tests FAILED:
	318 - MPACT_libsUtils_testAllocs_MPI_1 (Failed)
	362 - MPACT_libsMOC_testMOCSweeper_P0_MPI_1 (Failed)
	364 - MPACT_libsMOC_testMOCSweeper_AngSrc_MPI_1 (Failed)
	372 - MPACT_libsNodal_testNodalSweeper_MPI_4 (Failed)
	259 - InsilicoMOC_tstEigenvalue_MOC_MPI_4 (Timeout)
}}}

Many of the tests that had timed out now finished.  The MPACT failures
don't seem to be related to system issues.
